#!/usr/bin/env bash
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
set -e
. "$STREAMPIPES_WORKDIR/bin/common"

docker_compose_api_version=3.4
svc_has_ports=false

cli_help_start() {
  cat <<EOF
Add new StreamPipes service to catalog.

Usage: streampipes add SERVICE [OPTIONS]

Examples:
streampipes add my-service
streampipes add my-service --image apachestreampipes/my-service:0.68.0 --ports 8090:8090 --ports 8091:8091

Options:
  -i, --image     Name of image (Default: ${SP_DOCKER_REGISTRY}/my-service:${SP_VERSION})
  -p, --ports     Port mapping for this service (externalPort:internalPort)
EOF

  exit 1
}

[ "$1" == '--help' ] || [ "$1" == '-h' ] && cli_help_start

if [ -z "$1" ]; then
    fatal "Argument missing, see 'streampipes ${0##*/} --help'"
fi

while [[ "$#" -gt 0 ]]; do
    case $1 in
        -i|--image)
          if [ -n "$2" ] && [ ${2:0:1} != "-" ]; then
            svc_img_tag="$2"
            shift 2
          else
            fatal "StreamPipes service image name for $1 is missing" >&2
          fi
          ;;
        -p|--ports)
          if [ -n "$2" ] && [ ${2:0:1} != "-" ]; then
            ports+=("$2")
            svc_has_ports=true
            shift 2
          else
            fatal "Ports for $1 is missing" >&2
          fi
          ;;
        -*|--*=) fatal "Unsupported flag $1, see 'streampipes ${0##*/} --help'" >&2 ; shift ;;
        # *) fatal "Wrong usage, see 'streampipes ${0##*/} --help'" ;;
        *)
          if [ ! -z "$1" ]; then
            svc_name=$1
            shift
          else
            fatal "Wrong usage, see 'streampipes ${0##*/} --help'"
          fi
        ;;
    esac
done

apache_license_header(){
  cat << EOF
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

EOF
}


add_docker_compose_file() {
  cat << EOF
$(apache_license_header)

version: "${docker_compose_api_version}"
services:
 ${svc_name}:
    image: ${svc_img_tag}
    depends_on:
      - "consul"
      - "backend"
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"
    networks:
      spnet:

networks:
  spnet:
    external: true
EOF
}

add_docker_compose_dev_file_with_ports() {
  cat << EOF
$(apache_license_header)

version: "${docker_compose_api_version}"
services:
  ${svc_name}:
EOF
  cat << EOF 
      ports:
$(get_port_mappings)
EOF
}

add_docker_compose_dev_file_without_ports() {
  cat << EOF
$(apache_license_header)

version: "${docker_compose_api_version}"
services:
  ${svc_name}:
EOF
}

get_port_mappings(){
  for port_mapping in "${ports[@]}"
  do
    cat << EOF
        - "$port_mapping"
EOF
  done
}

create_dir(){
  if [ ! -d "$1" ]; then
    mkdir $1
    info "Create new directory for: $1"
  else
    warning "Service already exists $svc_name"
    read -p 'Continue [y/n]: ' continue
    if [ "$continue" == "n" ] || [ "$continue" == "n" ]; then
        exit 1
    fi
  fi 
}

check_img_or_default(){
  if [ -z "$svc_img_tag" ]; then
      svc_img_tag="\${SP_DOCKER_REGISTRY}/$svc_name:\${SP_VERSION}"
  fi
}

create_docker_compose_files(){
  info "Generate Docker Compose files for $svc_name"
  check_img_or_default
  add_docker_compose_file > $1/docker-compose.yml

  if $svc_has_ports; then
    add_docker_compose_dev_file_with_ports > $1/docker-compose.dev.yml
  else
    add_docker_compose_dev_file_without_ports > $1/docker-compose.dev.yml
  fi
}

append_to_curr_env(){
  info "Added service to .spenv"
  curr_env_file=$STREAMPIPES_WORKDIR/.spenv
  grep -qxF $svc_name $curr_env_file || echo $svc_name >> $curr_env_file
}

add_to_current_environment(){
  get_curr_environment
  info "Add service to current environment: $curr_environment ?"
  read -p "Add [y/n]: " add
  if [ "$add" == "n" ] || [ "$add" == "n" ]; then
      exit 1
  else
    append_to_curr_env
  fi
}

add_service() {
  svc_dir=$STREAMPIPES_WORKDIR/deploy/standalone/${svc_name}
  create_dir $svc_dir
  create_docker_compose_files $svc_dir
  add_to_current_environment
}

add_service